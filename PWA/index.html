<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doraemon Ledger</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Iansui&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        doraBlue: '#8ED1FC',
                        macaronPink: '#F9A8D4',
                        macaronYellow: '#FDE68A',
                        macaronGreen: '#BBF7D0',
                        macaronPurple: '#DDD6FE',
                        bgBase: '#F8FAFC',
                    },
                    fontFamily: {
                        sans: ['Iansui', 'sans-serif'],
                    },
                    borderRadius: {
                        'giant': '2.5rem',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F8FAFC;
            font-family: 'Iansui', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* æ ¸å¿ƒå®¹å™¨é™åˆ¶ï¼šæ‰‹æ©Ÿå„ªå…ˆï¼Œæœ€å¤§ 500px */
        #app-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #F8FAFC;
            position: relative;
            padding-bottom: 100px; /* Space for Navbar */
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        /* ç»ç’ƒæ“¬æ…‹ Glassmorphism */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 2.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input, select, textarea {
            outline: none;
            background: rgba(255,255,255,0.8);
        }
        input:focus, select:focus, textarea:focus {
            background: #fff;
            box-shadow: 0 0 0 2px #8ED1FC;
        }

        /* Input Mode Layer åˆ‡æ› */
        .layer-hidden {
            display: none !important;
        }
        .layer-visible {
            display: block !important;
        }
    </style>
</head>
<body>

<div id="app-container">
    <main id="main-content" class="p-4"></main>

    <nav class="fixed bottom-0 left-0 right-0 max-w-[500px] mx-auto glass-nav pb-6 pt-3 px-4 z-50 rounded-t-[2rem]">
        <div class="flex justify-between items-center text-gray-500">
            <button onclick="router.navigate('logloot')" class="nav-btn flex flex-col items-center gap-1 w-12" data-page="logloot">
                <i data-lucide="pen-tool" class="w-6 h-6"></i>
                <span class="text-xs">è¨˜å¸³</span>
            </button>
            <button onclick="router.navigate('wallet')" class="nav-btn flex flex-col items-center gap-1 w-12" data-page="wallet">
                <i data-lucide="wallet" class="w-6 h-6"></i>
                <span class="text-xs">éŒ¢åŒ…</span>
            </button>
            <button onclick="router.navigate('my')" class="nav-btn flex flex-col items-center gap-1 w-12" data-page="my">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-xs">æˆ‘çš„</span>
            </button>
            <button onclick="router.navigate('history')" class="nav-btn flex flex-col items-center gap-1 w-12" data-page="history">
                <i data-lucide="history" class="w-6 h-6"></i>
                <span class="text-xs">æ­·å²</span>
            </button>
            <button onclick="router.navigate('settings')" class="nav-btn flex flex-col items-center gap-1 w-12" data-page="settings">
                <i data-lucide="settings" class="w-6 h-6"></i>
                <span class="text-xs">è¨­å®š</span>
            </button>
        </div>
    </nav>
</div>

<script>
// ==========================================
// 1. DATA & CONSTANTS (The Source of Truth)
// ==========================================

// Roster (äººå“¡è­˜åˆ¥è¦å‰‡)
const ROSTER = [
    { uid: "u001", name: "Smile", avatar: "ğŸš€", is_seed: true },
    { uid: "u002", name: "Jiani", avatar: "ğŸŒ»", is_seed: true },
    { uid: "u003", name: "Nomad", avatar: "âš½", is_seed: true },
    { uid: "u004", name: "Shared", avatar: "ğŸ”", is_seed: true } // å…¬æ¬¾
];

// Categories (åˆ†é¡æ¸…å–®)
const CATEGORIES = [
    { id: "food", icon: "ğŸ´", name: "é¤é£²", color: "bg-macaronPink" },
    { id: "transport", icon: "ğŸš„", name: "äº¤é€š", color: "bg-doraBlue" },
    { id: "stay", icon: "ğŸ ", name: "ä½å®¿", color: "bg-macaronYellow" },
    { id: "ticket", icon: "ğŸ«", name: "é–€ç¥¨", color: "bg-macaronGreen" },
    { id: "supply", icon: "ğŸ›’", name: "è£œçµ¦", color: "bg-macaronPurple" },
    { id: "gift", icon: "ğŸ", name: "æ‰‹ä¿¡", color: "bg-pink-200" },
    { id: "gear", icon: "ğŸ§¦", name: "è£å‚™", color: "bg-green-200" },
    { id: "other", icon: "ğŸ“¦", name: "å…¶ä»–", color: "bg-yellow-100" }
];

// Default Rates
const DEFAULT_RATES = {
    "TWD": 1.00,
    "USD": 31.50,
    "EUR": 34.80,
    "JPY": 0.22,
    "KRW": 0.024
};

// Quick Groups
const QUICK_GROUPS = [
    { name: "Solo", shares: ["u001"] },
    { name: "Duo", shares: ["u001", "u002"] },
    { name: "All", shares: ["u001", "u002", "u003"] } // ä¸å« u004
];

// ==========================================
// 2. STORAGE & CORE LOGIC (UID Iron Rule)
// ==========================================

const DB = {
    // Helpers
    get: (key, def) => JSON.parse(localStorage.getItem(key) || JSON.stringify(def)),
    set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),

    // Data Access
    getExpenses: () => DB.get('doraemon_expenses_v1', []),
    setExpenses: (data) => DB.set('doraemon_expenses_v1', data),
    
    getWallets: () => DB.get('doraemon_wallets_v1', []),
    setWallets: (data) => DB.set('doraemon_wallets_v1', data),
    
    getRates: () => DB.get('doraemon_currency_rates_v1', DEFAULT_RATES),
    setRates: (data) => DB.set('doraemon_currency_rates_v1', data),
};

const Core = {
    // åŒ¯ç‡æŸ¥è©¢ (Rate Lock Logic)
    getRate: (currency) => {
        const rates = DB.getRates();
        return rates[currency] || 1;
    },

    // å–å¾—äººå“¡è³‡æ–™ (UI Use Only)
    getPerson: (uid) => ROSTER.find(r => r.uid === uid) || { name: 'Unknown', avatar: 'â“' },
    
    // å–å¾—éŒ¢åŒ…è³‡æ–™
    getWallet: (walletId) => {
        const wallets = DB.getWallets();
        return wallets.find(w => w.walletId === walletId);
    },

    // æ›´æ–°éŒ¢åŒ…é¤˜é¡
    updateWalletBalance: (walletId, amountChange) => {
        const wallets = DB.getWallets();
        const idx = wallets.findIndex(w => w.walletId === walletId);
        if (idx !== -1) {
            wallets[idx].balance += amountChange; // amountChange ç‚ºè² æ•¸ä»£è¡¨æ‰£æ¬¾
            DB.setWallets(wallets);
        }
    },

    // æ–°å¢æ”¯å‡º (Log Loot Core)
    addExpense: (expenseData) => {
        const expenses = DB.getExpenses();
        const newExpense = {
            ...expenseData,
            expenseId: 'e' + Date.now() + Math.random().toString(36).substr(2, 5),
            createdAt: new Date().toISOString()
        };

        // ç¾é‡‘é‚è¼¯ï¼šæ‰£æ¬¾
        if (newExpense.paymentMethod === 'cash' && newExpense.walletId) {
            Core.updateWalletBalance(newExpense.walletId, -newExpense.amount);
        }

        expenses.unshift(newExpense); // æ–°çš„åœ¨å‰é¢
        DB.setExpenses(expenses);
        return newExpense;
    },

    // åˆªé™¤æ”¯å‡º (History Logic)
    deleteExpense: (expenseId) => {
        const expenses = DB.getExpenses();
        const exp = expenses.find(e => e.expenseId === expenseId);
        if (!exp) return;

        // ç¾é‡‘é‚è¼¯ï¼šå›è£œ
        if (exp.paymentMethod === 'cash' && exp.walletId) {
            Core.updateWalletBalance(exp.walletId, exp.amount); // åŠ å›æ­£æ•¸
        }

        const newExpenses = expenses.filter(e => e.expenseId !== expenseId);
        DB.setExpenses(newExpenses);
    },

    // æœå°‹éŒ¢åŒ… (Cash Logic)
    findWallet: (ownerUID, currency) => {
        const wallets = DB.getWallets();
        // å„ªå…ˆæ‰¾ owner ç¬¦åˆä¸” currency ç¬¦åˆçš„
        return wallets.find(w => w.ownerUID === ownerUID && w.currency === currency);
    }
};

// ==========================================
// 3. STATE MANAGEMENT (State Machine)
// ==========================================

// Global App State
let AppState = {
    currentPage: 'logloot',
    
    // Log Loot State
    logLoot: {
        description: "",
        amount: "",
        currency: "JPY", // Default
        payer: "u001",
        shares: ["u001"],
        paymentMethod: "cash",
        category: "food",
        date: new Date().toISOString().split('T')[0],
        notes: "",
        isAdvanced: false
    },

    // History Filter State
    history: {
        dateRange: { start: null, end: null }, // null means all
        category: null,
        payer: null,
        paymentMethod: null,
        currency: null,
        expandedId: null // å“ªä¸€ç­†è¢«å±•é–‹
    },
    
    // Wallet Expand State
    walletExpandedId: null,

    // My Page State
    myUid: "u001"
};

// ==========================================
// 4. UI RENDERERS (Component-like)
// ==========================================

const router = {
    navigate: (page) => {
        AppState.currentPage = page;
        renderApp();
        
        // Update Nav Active State
        document.querySelectorAll('.nav-btn').forEach(btn => {
            if (btn.dataset.page === page) {
                btn.classList.add('text-doraBlue');
                btn.classList.remove('text-gray-500');
            } else {
                btn.classList.remove('text-doraBlue');
                btn.classList.add('text-gray-500');
            }
        });
    }
};

function renderApp() {
    const main = document.getElementById('main-content');
    main.innerHTML = ''; // Clear

    switch(AppState.currentPage) {
        case 'logloot':
            renderLogLoot(main);
            break;
        case 'wallet':
            renderWallet(main);
            break;
        case 'my':
            renderMy(main);
            break;
        case 'history':
            renderHistory(main);
            break;
        case 'settings':
            renderSettings(main);
            break;
    }
    lucide.createIcons();
}

// ------------------------------------------
// PAGE: LOG LOOT (è¨˜å¸³)
// ------------------------------------------
function renderLogLoot(container) {
    const s = AppState.logLoot;
    const rate = (s.paymentMethod === 'cash') 
        ? (Core.findWallet(s.payer, s.currency)?.rate || Core.getRate(s.currency)) // è‹¥ç„¡éŒ¢åŒ…æš«ç”¨è¨­å®šåŒ¯ç‡é¡¯ç¤ºï¼Œä½†å¯¦éš›è¨˜å¸³æœƒæª¢æŸ¥
        : Core.getRate(s.currency);
    
    const twdVal = (parseFloat(s.amount) || 0) * rate;

    // --- Template Helpers ---
    const getAvatar = (uid) => Core.getPerson(uid).avatar;
    
    // Main Input Layer
    const mainLayerClass = s.isAdvanced ? "hidden" : "block";
    const advLayerClass = s.isAdvanced ? "block fixed top-0 left-0 w-full h-full bg-bgBase z-50 p-4 overflow-y-auto" : "hidden";

    container.innerHTML = `
        <div class="flex justify-between items-center mb-6 px-2">
            <h1 class="text-2xl font-bold text-gray-700">è¨˜å¸³ <span class="text-sm font-normal text-gray-400">Log Loot</span></h1>
            <button id="btn-toggle-adv" class="p-2 rounded-full bg-white shadow text-doraBlue">
                <i data-lucide="${s.isAdvanced ? 'arrow-down' : 'settings'}" class="w-5 h-5"></i>
            </button>
        </div>

        <div id="adv-layer" class="${advLayerClass}">
            <div class="max-w-[500px] mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-700">é«˜ç´šè¨­å®š</h2>
                    <button onclick="toggleAdvanced(false)" class="p-2 rounded-full bg-white shadow">
                        <i data-lucide="x" class="w-6 h-6 text-gray-500"></i>
                    </button>
                </div>
                
                <div class="glass-card p-6 space-y-4 mb-6">
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">æ—¥æœŸ</label>
                        <input type="date" id="inp-date" value="${s.date}" class="w-full p-3 rounded-xl text-center text-lg bg-white/50">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">å‚™è¨»</label>
                        <textarea id="inp-notes" rows="3" class="w-full p-3 rounded-xl bg-white/50" placeholder="å¯«é»ä»€éº¼...">${s.notes}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-500 mb-2">è©³ç´°åˆ†æ”¤ (é»æ“Šé¸å–)</label>
                        <div class="flex flex-wrap gap-2">
                            ${ROSTER.map(r => `
                                <button onclick="toggleShare('${r.uid}')" 
                                    class="flex items-center gap-1 px-3 py-2 rounded-full border ${s.shares.includes(r.uid) ? 'bg-doraBlue text-white border-transparent' : 'bg-white text-gray-500 border-gray-200'}">
                                    <span>${r.avatar}</span> <span>${r.name}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <button onclick="toggleAdvanced(false)" class="w-full py-4 rounded-giant bg-doraBlue text-white text-lg shadow-lg font-bold">ç¢ºèªè¿”å›</button>
            </div>
        </div>

        <div id="main-layer" class="${mainLayerClass} space-y-4">
            
            <div class="flex gap-3">
                <input type="text" id="inp-desc" value="${s.description}" placeholder="é …ç›®åç¨±..." 
                    class="flex-1 p-4 rounded-giant text-lg shadow-sm border-none bg-white focus:ring-2 ring-doraBlue transition-all">
                
                <select id="inp-curr" onchange="updateLogState('currency', this.value)" 
                    class="w-24 p-2 rounded-giant text-center font-bold bg-macaronYellow text-gray-700 appearance-none shadow-sm">
                    ${Object.keys(DEFAULT_RATES).map(c => `<option value="${c}" ${s.currency === c ? 'selected' : ''}>${c}</option>`).join('')}
                </select>
            </div>

            <div class="flex gap-3 items-center">
                <input type="number" inputmode="decimal" id="inp-amt" value="${s.amount}" placeholder="0" 
                    class="flex-1 p-4 rounded-giant text-3xl font-bold text-gray-700 text-center shadow-inner bg-white focus:ring-2 ring-macaronPink transition-all">
                
                <button onclick="submitExpense()" class="w-16 h-16 rounded-full bg-macaronPink text-white shadow-lg flex items-center justify-center active:scale-95 transition-transform">
                    <i data-lucide="send" class="w-8 h-8 ml-1"></i>
                </button>
            </div>

            <div class="grid grid-cols-4 gap-3 mt-4">
                ${CATEGORIES.map(c => `
                    <button onclick="updateLogState('category', '${c.id}')" 
                        class="aspect-square rounded-[1.5rem] flex flex-col items-center justify-center gap-1 shadow-sm transition-transform active:scale-95 
                        ${s.category === c.id ? c.color + ' ring-2 ring-offset-1 ring-gray-300' : 'bg-white'}">
                        <span class="text-2xl">${c.icon}</span>
                        <span class="text-[10px] text-gray-600">${c.name}</span>
                    </button>
                `).join('')}
            </div>

            <div class="glass-card p-4 mt-4 flex justify-between items-center">
                <button onclick="cyclePayer()" class="flex flex-col items-center w-1/3 border-r border-gray-200">
                    <span class="text-xs text-gray-400 mb-1">èª°ä»˜éŒ¢</span>
                    <div class="text-2xl bounce-anim">${getAvatar(s.payer)}</div>
                </button>

                <button onclick="cycleShares()" class="flex flex-col items-center w-1/3 border-r border-gray-200">
                    <span class="text-xs text-gray-400 mb-1">èª°åˆ†æ”¤</span>
                    <div class="flex -space-x-2 overflow-hidden">
                        ${s.shares.slice(0, 3).map(uid => `<span class="bg-gray-100 rounded-full w-6 h-6 flex items-center justify-center text-xs border border-white">${getAvatar(uid)}</span>`).join('')}
                        ${s.shares.length > 3 ? '<span class="text-xs text-gray-400 ml-1">...</span>' : ''}
                    </div>
                </button>

                <button onclick="togglePayment()" class="flex flex-col items-center w-1/3">
                    <span class="text-xs text-gray-400 mb-1">æ–¹å¼</span>
                    <div class="text-sm font-bold ${s.paymentMethod === 'cash' ? 'text-green-500' : 'text-blue-500'}">
                        ${s.paymentMethod === 'cash' ? 'ğŸ’µ ç¾é‡‘' : 'ğŸ’³ ä¿¡ç”¨å¡'}
                    </div>
                </button>
            </div>

            <div class="text-center mt-4 px-2">
                <p class="text-xs text-gray-800 font-mono">
                    ${s.date.slice(5).replace('-','/')}, ${Core.getPerson(s.payer).name}æ”¯ä»˜, 
                    ${s.shares.length}äººåˆ†, 
                    ${s.paymentMethod === 'cash' ? 'ç¾é‡‘' : 'ä¿¡ç”¨'}, 
                    ${s.currency} @${rate.toFixed(2)}
                    <br>
                    <span class="text-gray-400">ç´„ TWD ${Math.round(twdVal).toLocaleString()}</span>
                </p>
            </div>
        </div>
    `;

    // Event Bindings for Inputs
    document.getElementById('btn-toggle-adv').onclick = () => toggleAdvanced(!s.isAdvanced);
    
    // Focus Flow Logic
    const descInput = document.getElementById('inp-desc');
    const amtInput = document.getElementById('inp-amt');
    
    if(!s.isAdvanced) {
        // Bind updates
        descInput.oninput = (e) => AppState.logLoot.description = e.target.value;
        amtInput.oninput = (e) => AppState.logLoot.amount = e.target.value;
        
        // Keydown flow
        descInput.onkeydown = (e) => {
            if(e.key === 'Enter') {
                e.preventDefault();
                amtInput.focus();
            }
        };
        amtInput.onkeydown = (e) => {
            if(e.key === 'Enter') {
                e.preventDefault();
                submitExpense();
                descInput.focus();
            }
        };
    } else {
        // Advanced inputs bindings
        document.getElementById('inp-date').onchange = (e) => AppState.logLoot.date = e.target.value;
        document.getElementById('inp-notes').oninput = (e) => AppState.logLoot.notes = e.target.value;
    }
}

// Log Loot Actions
function updateLogState(key, val) {
    AppState.logLoot[key] = val;
    renderApp();
    // Maintain focus if simple update
    if(key === 'category') return; // no focus needed
    if(key === 'currency') document.getElementById('inp-amt').focus();
}

function toggleAdvanced(isShow) {
    AppState.logLoot.isAdvanced = isShow;
    renderApp();
}

function cyclePayer() {
    const currentIdx = ROSTER.findIndex(r => r.uid === AppState.logLoot.payer);
    const nextIdx = (currentIdx + 1) % ROSTER.length;
    AppState.logLoot.payer = ROSTER[nextIdx].uid;
    renderApp();
}

function cycleShares() {
    // Check if current shares match a quick group
    const currentJSON = JSON.stringify(AppState.logLoot.shares.sort());
    let nextGroupIdx = -1;
    
    QUICK_GROUPS.forEach((g, idx) => {
        if(JSON.stringify(g.shares.sort()) === currentJSON) nextGroupIdx = idx;
    });

    const nextGroup = QUICK_GROUPS[(nextGroupIdx + 1) % QUICK_GROUPS.length];
    AppState.logLoot.shares = [...nextGroup.shares];
    renderApp();
}

function toggleShare(uid) {
    const shares = AppState.logLoot.shares;
    if(shares.includes(uid)) {
        if(shares.length > 1) AppState.logLoot.shares = shares.filter(u => u !== uid);
    } else {
        AppState.logLoot.shares.push(uid);
    }
    renderApp();
}

function togglePayment() {
    AppState.logLoot.paymentMethod = (AppState.logLoot.paymentMethod === 'cash') ? 'credit' : 'cash';
    renderApp();
}

function submitExpense() {
    const s = AppState.logLoot;
    if(!s.amount || parseFloat(s.amount) <= 0) {
        alert("è«‹è¼¸å…¥é‡‘é¡ï¼");
        return;
    }
    if(!s.description) {
        alert("è«‹è¼¸å…¥é …ç›®åç¨±ï¼");
        return;
    }

    // Determine Wallet & Rate
    let appliedRate = 1;
    let targetWalletId = null;

    if (s.paymentMethod === 'cash') {
        const wallet = Core.findWallet(s.payer, s.currency);
        if(!wallet) {
            alert(`æ‰¾ä¸åˆ° ${Core.getPerson(s.payer).name} çš„ ${s.currency} éŒ¢åŒ…ï¼\nè«‹å…ˆåˆ°éŒ¢åŒ…é é¢å»ºç«‹ã€‚`);
            return;
        }
        targetWalletId = wallet.walletId;
        appliedRate = wallet.rate;
    } else {
        appliedRate = Core.getRate(s.currency);
    }

    const expenseData = {
        description: s.description,
        amount: parseFloat(s.amount),
        currency: s.currency,
        appliedRate: appliedRate,
        twdEquivalent: parseFloat(s.amount) * appliedRate,
        payerUID: s.payer,
        shares: s.shares, // Array of UIDs
        paymentMethod: s.paymentMethod,
        walletId: targetWalletId,
        category: s.category,
        dateTime: s.date + ' ' + new Date().toTimeString().slice(0,5),
        notes: s.notes
    };

    Core.addExpense(expenseData);

    // Reset Fields but keep context
    AppState.logLoot.description = "";
    AppState.logLoot.amount = "";
    AppState.logLoot.notes = "";
    // Keep date, payer, shares, etc.
    
    renderApp();
    // Focus flow logic is handled in renderLogLoot event binding, 
    // but here we force re-focus after render
    setTimeout(() => document.getElementById('inp-desc')?.focus(), 50);
}

// ------------------------------------------
// PAGE: WALLET (éŒ¢åŒ…)
// ------------------------------------------
function renderWallet(container) {
    const wallets = DB.getWallets();
    
    // Sort wallets: Balance > 0 first, then by owner
    wallets.sort((a,b) => (b.balance - a.balance));

    container.innerHTML = `
        <div class="flex justify-between items-center mb-6 px-2">
            <h1 class="text-2xl font-bold text-gray-700">éŒ¢åŒ… <span class="text-sm font-normal text-gray-400">Assets</span></h1>
            <button onclick="showAddWalletModal()" class="flex items-center gap-1 bg-doraBlue text-white px-4 py-2 rounded-full shadow hover:bg-blue-400">
                <i data-lucide="plus" class="w-4 h-4"></i> æ–°å¢
            </button>
        </div>

        <div class="grid gap-4">
            ${wallets.map(w => {
                const person = Core.getPerson(w.ownerUID);
                const isExpanded = AppState.walletExpandedId === w.walletId;
                
                // Get History if expanded
                let historyHtml = '';
                if(isExpanded) {
                    const txns = DB.getExpenses()
                        .filter(e => e.walletId === w.walletId)
                        .sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime))
                        .slice(0, 20);
                        
                    historyHtml = `
                        <div class="mt-4 border-t border-gray-200 pt-3">
                            <h4 class="text-xs text-gray-400 mb-2">æœ€è¿‘ 20 ç­†æ‰£æ¬¾</h4>
                            <div class="space-y-2 max-h-60 overflow-y-auto hide-scrollbar">
                                ${txns.length === 0 ? '<div class="text-xs text-gray-300 text-center">ç„¡äº¤æ˜“ç´€éŒ„</div>' : ''}
                                ${txns.map(t => `
                                    <div class="flex justify-between text-xs items-center">
                                        <div class="flex flex-col">
                                            <span class="text-gray-600 font-bold">${t.description}</span>
                                            <span class="text-gray-400">${t.dateTime.slice(5, 10)}</span>
                                        </div>
                                        <span class="text-red-400 font-mono">-${t.amount.toLocaleString()}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="deleteWallet('${w.walletId}')" class="mt-4 w-full py-2 text-xs text-red-400 border border-red-200 rounded-full hover:bg-red-50">åˆªé™¤æ­¤éŒ¢åŒ…</button>
                        </div>
                    `;
                }

                return `
                    <div class="glass-card p-5 relative overflow-hidden transition-all duration-300">
                        <div onclick="toggleWalletExpand('${w.walletId}')" class="cursor-pointer">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-3">
                                    <div class="text-4xl bg-white/50 w-16 h-16 rounded-full flex items-center justify-center shadow-sm">
                                        ${person.avatar}
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-400 font-mono uppercase tracking-widest">${w.currency}</div>
                                        <div class="text-2xl font-bold text-gray-700">${w.balance.toLocaleString()}</div>
                                        <div class="text-[10px] text-gray-400 mt-1">åˆå§‹: ${w.originalAmount.toLocaleString()} @ ${w.rate}</div>
                                    </div>
                                </div>
                                <div class="bg-macaronGreen/50 px-3 py-1 rounded-full text-[10px] text-green-800 font-bold">
                                    CASH
                                </div>
                            </div>
                        </div>
                        
                        ${historyHtml}
                    </div>
                `;
            }).join('')}
            
            ${wallets.length === 0 ? '<div class="text-center text-gray-400 mt-10">é‚„æ²’æœ‰éŒ¢åŒ…ï¼Œé»æ“Šå³ä¸Šè§’æ–°å¢ï¼</div>' : ''}
        </div>
    `;
}

function toggleWalletExpand(wid) {
    AppState.walletExpandedId = (AppState.walletExpandedId === wid) ? null : wid;
    renderApp();
}

function showAddWalletModal() {
    const owner = prompt("æ“æœ‰è€… UID (u001=Smile, u002=Jiani, u003=Nomad, u004=Shared):", "u001");
    if(!ROSTER.find(r => r.uid === owner)) { alert("UID ä¸å­˜åœ¨"); return; }
    
    const curr = prompt("å¹£åˆ¥ (JPY, USD, EUR...):", "JPY");
    if(!curr) return;
    
    const amt = parseFloat(prompt("åŸå§‹é‡‘é¡:", "50000"));
    if(isNaN(amt)) return;
    
    const rate = parseFloat(prompt("æ›åŒ¯åŒ¯ç‡ (TWD):", "0.22"));
    if(isNaN(rate)) return;

    const wallets = DB.getWallets();
    wallets.push({
        walletId: 'w' + Date.now(),
        ownerUID: owner,
        currency: curr.toUpperCase(),
        originalAmount: amt,
        balance: amt,
        rate: rate,
        createdAt: new Date().toISOString()
    });
    DB.setWallets(wallets);
    renderApp();
}

function deleteWallet(wid) {
    if(confirm("ç¢ºå®šåˆªé™¤æ­¤éŒ¢åŒ…ï¼Ÿ\næ­·å²å¸³ç›®ä¸æœƒæ¶ˆå¤±ï¼Œä½†ç„¡æ³•å†è¿½è¹¤é¤˜é¡ã€‚")) {
        const wallets = DB.getWallets().filter(w => w.walletId !== wid);
        DB.setWallets(wallets);
        renderApp();
    }
}

// ------------------------------------------
// PAGE: MY (æˆ‘çš„)
// ------------------------------------------
function renderMy(container) {
    const uid = AppState.myUid;
    const expenses = DB.getExpenses();
    const person = Core.getPerson(uid);

    // Calc Stats
    let totalOutflow = 0; // å¢Šä»˜
    let actualConsumption = 0; // å¯¦éš›è² æ“”
    let categoryStats = {};

    expenses.forEach(e => {
        // Outflow
        if(e.payerUID === uid) totalOutflow += e.twdEquivalent;

        // Consumption
        if(e.shares.includes(uid)) {
            // My Share = Total / People Count
            const shareCount = e.shares.length;
            const myShareAmt = e.twdEquivalent / shareCount;
            actualConsumption += myShareAmt;

            // Category breakdown
            if(!categoryStats[e.category]) categoryStats[e.category] = 0;
            categoryStats[e.category] += myShareAmt;
        }
    });

    // Sort categories by amount
    const sortedCats = Object.entries(categoryStats).sort((a,b) => b[1] - a[1]);

    container.innerHTML = `
        <div class="flex items-center gap-4 mb-6 px-2">
            <h1 class="text-2xl font-bold text-gray-700">æˆ‘çš„ <span class="text-sm font-normal text-gray-400">Analysis</span></h1>
            <select onchange="AppState.myUid=this.value; renderApp()" class="bg-white p-1 rounded-lg text-sm border shadow-sm">
                ${ROSTER.map(r => `<option value="${r.uid}" ${r.uid===uid?'selected':''}>${r.avatar} ${r.name}</option>`).join('')}
            </select>
        </div>

        <div class="glass-card p-6 mb-6 bg-gradient-to-br from-white/80 to-doraBlue/20">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-3xl">${person.avatar}</span>
                    <span class="text-xl font-bold text-gray-700">${person.name}</span>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white/50 p-3 rounded-[1.5rem] text-center">
                    <div class="text-[10px] text-gray-400 uppercase">Actual Consumption</div>
                    <div class="text-xl font-bold text-doraBlue">$${Math.round(actualConsumption).toLocaleString()}</div>
                    <div class="text-[10px] text-gray-400">å¯¦éš›èŠ±è²»</div>
                </div>
                <div class="bg-white/50 p-3 rounded-[1.5rem] text-center">
                    <div class="text-[10px] text-gray-400 uppercase">Total Outflow</div>
                    <div class="text-xl font-bold text-macaronPink">$${Math.round(totalOutflow).toLocaleString()}</div>
                    <div class="text-[10px] text-gray-400">ç¸½å¢Šä»˜</div>
                </div>
            </div>
        </div>

        <div class="space-y-4 px-2">
            <h3 class="text-sm text-gray-400 font-bold ml-1">åˆ†é¡ä½”æ¯” (å¯¦éš›è² æ“”)</h3>
            ${sortedCats.map(([catId, amt]) => {
                const cat = CATEGORIES.find(c => c.id === catId) || {name: catId, color: 'bg-gray-300', icon: 'â“'};
                const pct = Math.round((amt / actualConsumption) * 100);
                const isExpanded = AppState.history.category === catId && AppState.currentPage === 'my'; // Reusing simple logic
                
                return `
                <div onclick="toggleMyCatExpand('${catId}')" class="cursor-pointer">
                    <div class="flex justify-between items-end mb-1">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${cat.icon}</span>
                            <span class="text-sm text-gray-600 font-bold">${cat.name}</span>
                        </div>
                        <div class="text-xs font-mono text-gray-500">$${Math.round(amt).toLocaleString()} <span class="text-[10px] text-gray-300">(${pct}%)</span></div>
                    </div>
                    <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full ${cat.color} rounded-full" style="width: ${pct}%"></div>
                    </div>
                    
                    <div id="my-cat-detail-${catId}" class="${AppState.myCatExpand === catId ? 'block' : 'hidden'} mt-3 space-y-2 pl-2 border-l-2 border-gray-200">
                        ${getRecentMyCatExpenses(uid, catId).map(e => `
                            <div class="flex justify-between text-[10px] items-center text-gray-500">
                                <span>${e.date} ${e.desc}</span>
                                <span class="font-bold">NT$${Math.round(e.myShare)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                `;
            }).join('')}
        </div>
    `;
}

function toggleMyCatExpand(catId) {
    AppState.myCatExpand = (AppState.myCatExpand === catId) ? null : catId;
    renderApp();
}

function getRecentMyCatExpenses(uid, catId) {
    const expenses = DB.getExpenses();
    return expenses
        .filter(e => e.shares.includes(uid) && e.category === catId)
        .sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime))
        .slice(0, 20)
        .map(e => ({
            date: e.dateTime.slice(5,10),
            desc: e.description,
            myShare: e.twdEquivalent / e.shares.length
        }));
}


// ------------------------------------------
// PAGE: HISTORY (æ­·å²)
// ------------------------------------------
function renderHistory(container) {
    const s = AppState.history;
    let expenses = DB.getExpenses();

    // Filters
    if(s.dateRange.start && s.dateRange.end) {
        expenses = expenses.filter(e => {
            const d = e.dateTime.slice(0, 10);
            return d >= s.dateRange.start && d <= s.dateRange.end;
        });
    }
    if(s.category) expenses = expenses.filter(e => e.category === s.category);
    if(s.payer) expenses = expenses.filter(e => e.payerUID === s.payer);
    if(s.paymentMethod) expenses = expenses.filter(e => e.paymentMethod === s.paymentMethod);
    if(s.currency) expenses = expenses.filter(e => e.currency === s.currency);

    // Stats Bar
    const totalTwd = expenses.reduce((sum, e) => sum + e.twdEquivalent, 0);
    
    // UI
    container.innerHTML = `
        <div class="mb-4 sticky top-0 bg-bgBase/95 backdrop-blur z-20 pb-2">
            <h1 class="text-2xl font-bold text-gray-700 px-2 mb-2">æ­·å² <span class="text-sm font-normal text-gray-400">History</span></h1>
            
            <div class="mb-2 px-1">
                <button onclick="changeDateFilter()" class="w-full glass-card py-2 px-4 flex items-center justify-center gap-2 text-sm text-gray-600 font-bold">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    ${s.dateRange.start ? `${s.dateRange.start} ~ ${s.dateRange.end}` : 'æ‰€æœ‰æ—¥æœŸç¯„åœ'}
                </button>
            </div>

            <div class="flex gap-2 overflow-x-auto hide-scrollbar px-1 pb-1">
                <button onclick="resetHistoryFilter()" class="flex-none p-2 rounded-full bg-gray-200 text-gray-600">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                </button>
                
                <button onclick="changeCatFilter()" class="flex-none px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border ${s.category ? 'bg-macaronPink text-white border-transparent' : 'bg-white text-gray-500 border-gray-200'}">
                   ${s.category ? CATEGORIES.find(c=>c.id===s.category).name : 'åˆ†é¡'}
                </button>

                <button onclick="changePayerFilter()" class="flex-none px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border ${s.payer ? 'bg-doraBlue text-white border-transparent' : 'bg-white text-gray-500 border-gray-200'}">
                   ${s.payer ? Core.getPerson(s.payer).name : 'æ”¯ä»˜è€…'}
                </button>

                <button onclick="cycleMethodFilter()" class="flex-none px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border ${s.paymentMethod ? 'bg-green-400 text-white border-transparent' : 'bg-white text-gray-500 border-gray-200'}">
                   ${s.paymentMethod === 'cash' ? 'ç¾é‡‘' : (s.paymentMethod === 'credit' ? 'ä¿¡ç”¨å¡' : 'æ–¹å¼')}
                </button>
            </div>
            
            <div class="mt-2 flex justify-between items-center px-4 py-2 bg-gray-100 rounded-full mx-1">
                <span class="text-xs text-gray-500">ç­†æ•¸: ${expenses.length}</span>
                <span class="text-sm font-bold text-gray-700">ç¸½è¨ˆ: NT$${Math.round(totalTwd).toLocaleString()}</span>
            </div>
        </div>

        <div class="space-y-3 pb-20">
            ${expenses.map(e => {
                const cat = CATEGORIES.find(c => c.id === e.category);
                const isExpanded = s.expandedId === e.expenseId;
                const payer = Core.getPerson(e.payerUID);
                
                let detailHtml = '';
                if(isExpanded) {
                    const perPerson = Math.round(e.twdEquivalent / e.shares.length);
                    detailHtml = `
                        <div class="mt-3 pt-3 border-t border-gray-200 space-y-2 text-xs text-gray-600 animation-slide-down">
                            <div class="flex justify-between">
                                <span>åŸå¹£é‡‘é¡:</span>
                                <span class="font-mono">${e.currency} ${e.amount.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>åŒ¯ç‡:</span>
                                <span class="font-mono">${e.appliedRate}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>åˆ†æ”¤äººæ•¸:</span>
                                <span>${e.shares.length} äºº (${e.shares.map(u => Core.getPerson(u).avatar).join('')})</span>
                            </div>
                            <div class="flex justify-between text-doraBlue font-bold">
                                <span>æ¯äººè² æ“”:</span>
                                <span>NT$${perPerson.toLocaleString()}</span>
                            </div>
                            ${e.notes ? `<div class="bg-yellow-50 p-2 rounded mt-2">ğŸ“ ${e.notes}</div>` : ''}
                            
                            <button onclick="Core.deleteExpense('${e.expenseId}');renderApp()" class="w-full mt-2 py-2 text-red-400 border border-red-200 rounded-lg hover:bg-red-50">åˆªé™¤æ­¤ç´€éŒ„</button>
                        </div>
                    `;
                }

                return `
                <div onclick="toggleHistoryExpand('${e.expenseId}')" class="glass-card p-4 border-l-4 ${cat.color.replace('bg-', 'border-')} cursor-pointer">
                    <div class="flex justify-between items-start">
                        <div class="flex gap-3">
                            <div class="mt-1 text-2xl">${cat.icon}</div>
                            <div>
                                <div class="text-[10px] text-gray-400">${e.dateTime.slice(0, 16)}</div>
                                <div class="font-bold text-gray-700">${e.description}</div>
                                <div class="flex items-center gap-1 mt-1">
                                    <span class="text-xs bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">${payer.name} ä»˜</span>
                                    <span class="text-[10px] text-gray-400">${e.paymentMethod==='cash'?'ç¾é‡‘':'å¡'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-800">NT$${Math.round(e.twdEquivalent).toLocaleString()}</div>
                            <div class="text-[10px] text-gray-400">${e.currency}</div>
                        </div>
                    </div>
                    ${detailHtml}
                </div>
                `;
            }).join('')}
            ${expenses.length === 0 ? '<div class="text-center text-gray-400 mt-10">ç„¡ç¬¦åˆæ¢ä»¶ç´€éŒ„</div>' : ''}
        </div>
    `;
}

function toggleHistoryExpand(eid) {
    AppState.history.expandedId = (AppState.history.expandedId === eid) ? null : eid;
    renderApp();
}

function resetHistoryFilter() {
    AppState.history = {
        dateRange: { start: null, end: null },
        category: null,
        payer: null,
        paymentMethod: null,
        currency: null,
        expandedId: null
    };
    renderApp();
}

function changeDateFilter() {
    // Simple prompt for demo, ideally a modal
    const start = prompt("é–‹å§‹æ—¥æœŸ (YYYY-MM-DD):", new Date().toISOString().slice(0,10));
    if(!start) return;
    const end = prompt("çµæŸæ—¥æœŸ (YYYY-MM-DD):", start);
    AppState.history.dateRange = { start, end };
    renderApp();
}

function changeCatFilter() {
    // Cycle simple logic or prompt
    const catName = prompt("è¼¸å…¥åˆ†é¡åç¨± (é¤é£²/äº¤é€š...):");
    const cat = CATEGORIES.find(c => c.name === catName);
    if(cat) AppState.history.category = cat.id;
    else AppState.history.category = null;
    renderApp();
}

function changePayerFilter() {
    const name = prompt("è¼¸å…¥ä»˜æ¬¾äººåå­— (Smile/Jiani...):");
    const person = ROSTER.find(r => r.name === name);
    if(person) AppState.history.payer = person.uid;
    else AppState.history.payer = null;
    renderApp();
}

function cycleMethodFilter() {
    const m = AppState.history.paymentMethod;
    if(m === null) AppState.history.paymentMethod = 'cash';
    else if(m === 'cash') AppState.history.paymentMethod = 'credit';
    else AppState.history.paymentMethod = null;
    renderApp();
}


// ------------------------------------------
// PAGE: SETTINGS (è¨­å®š)
// ------------------------------------------
function renderSettings(container) {
    const rates = DB.getRates();
    
    container.innerHTML = `
        <div class="px-2 mb-6">
            <h1 class="text-2xl font-bold text-gray-700 mb-2">è¨­å®š <span class="text-sm font-normal text-gray-400">Settings</span></h1>
            
            <div class="bg-macaronPurple/20 p-4 rounded-[2rem] mb-6">
                <div class="flex items-start gap-3 mb-4">
                    <i data-lucide="info" class="text-doraBlue w-6 h-6 flex-none"></i>
                    <p class="text-xs text-gray-600 leading-relaxed">
                        <strong>åŒ¯ç‡é–å®šèªªæ˜ï¼š</strong><br>
                        é€™è£¡è¨­å®šçš„æ˜¯ã€Œæ—…è¡Œåƒè€ƒåŒ¯ç‡ã€èˆ‡ã€Œä¿¡ç”¨å¡è¨˜å¸³åŒ¯ç‡ã€ã€‚
                        ä¿®æ”¹å¾Œåªæœƒå½±éŸ¿æœªä¾†çš„è¨˜å¸³ï¼ŒèˆŠå¸³ç›®èˆ‡ç¾é‡‘éŒ¢åŒ…ä¸å—å½±éŸ¿ã€‚
                    </p>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    ${Object.entries(rates).map(([curr, rate]) => `
                        <div class="glass-card p-3 text-center relative group">
                            <div class="font-bold text-gray-700">${curr}</div>
                            <div class="text-[10px] text-gray-400 mb-1">1 ${curr} =</div>
                            <input type="number" step="0.01" value="${rate}" 
                                onchange="saveRate('${curr}', this.value)"
                                class="w-full text-center font-mono font-bold text-doraBlue bg-transparent border-b border-gray-300 focus:border-doraBlue">
                            <div class="text-[10px] text-gray-400 mt-1">TWD</div>
                        </div>
                    `).join('')}
                    <button onclick="addCurrency()" class="glass-card p-3 flex flex-col items-center justify-center text-gray-400 border-dashed border-2 border-gray-300">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                        <span class="text-xs">æ–°å¢å¹£åˆ¥</span>
                    </button>
                </div>
            </div>

            <h2 class="text-lg font-bold text-gray-700 mb-3 px-2">è³‡æ–™ç®¡ç†</h2>
            <div class="space-y-3">
                <div class="flex gap-3">
                    <button onclick="exportCSV('expenses')" class="flex-1 py-3 bg-doraBlue text-white rounded-full shadow text-sm font-bold">åŒ¯å‡º Expenses CSV</button>
                    <button onclick="triggerImport('expenses')" class="flex-1 py-3 bg-white text-doraBlue border border-doraBlue rounded-full shadow text-sm font-bold">åŒ¯å…¥ Expenses</button>
                </div>
                <div class="flex gap-3">
                    <button onclick="exportCSV('wallet')" class="flex-1 py-3 bg-macaronYellow text-gray-700 rounded-full shadow text-sm font-bold">åŒ¯å‡º Wallet CSV</button>
                    <button onclick="triggerImport('wallet')" class="flex-1 py-3 bg-white text-gray-700 border border-gray-300 rounded-full shadow text-sm font-bold">åŒ¯å…¥ Wallet</button>
                </div>
                
                <div class="pt-6 border-t border-gray-200 mt-6">
                    <button onclick="resetAllData()" class="w-full py-3 bg-red-100 text-red-500 rounded-full text-sm font-bold hover:bg-red-200">
                        âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™ (Reset All)
                    </button>
                </div>
            </div>
        </div>
        
        <input type="file" id="file-import" class="hidden" accept=".csv">
    `;
}

function saveRate(curr, val) {
    const rates = DB.getRates();
    rates[curr] = parseFloat(val);
    DB.setRates(rates);
}

function addCurrency() {
    const curr = prompt("å¹£åˆ¥ä»£ç¢¼ (ä¾‹å¦‚ GBP):");
    if(!curr) return;
    const rate = parseFloat(prompt(`1 ${curr.toUpperCase()} = ? TWD`));
    if(isNaN(rate)) return;
    saveRate(curr.toUpperCase(), rate);
    renderApp();
}

function resetAllData() {
    if(confirm("è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰è¨˜å¸³èˆ‡éŒ¢åŒ…è³‡æ–™ï¼ç¢ºå®šå—ï¼Ÿ")) {
        localStorage.clear();
        location.reload();
    }
}

// ------------------------------------------
// EXPORT / IMPORT LOGIC
// ------------------------------------------
function exportCSV(type) {
    let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM for Excel
    const dateStr = new Date().toISOString().slice(0,10);
    
    if(type === 'expenses') {
        const data = DB.getExpenses();
        // Header
        csvContent += "expenseId,date,category,description,amount,currency,appliedRate,twdEquivalent,payerUID,shares,paymentMethod,walletId,notes\n";
        // Rows
        data.forEach(e => {
            const row = [
                e.expenseId,
                e.dateTime.slice(0,10),
                e.category,
                `"${e.description}"`,
                e.amount,
                e.currency,
                e.appliedRate,
                e.twdEquivalent,
                e.payerUID,
                `"${e.shares.join('|')}"`,
                e.paymentMethod,
                e.walletId || '',
                `"${e.notes}"`
            ];
            csvContent += row.join(",") + "\n";
        });
    } else {
        const data = DB.getWallets();
        csvContent += "walletId,ownerUID,currency,originalAmount,balance,rate,createdAt\n";
        data.forEach(w => {
            const row = [
                w.walletId, w.ownerUID, w.currency, w.originalAmount, w.balance, w.rate, w.createdAt
            ];
            csvContent += row.join(",") + "\n";
        });
    }

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `doraemon_${type}_${dateStr}.csv`);
    document.body.appendChild(link);
    link.click();
}

function triggerImport(type) {
    const input = document.getElementById('file-import');
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(evt) {
            const text = evt.target.result;
            processCSV(type, text);
        };
        reader.readAsText(file);
    };
    input.click();
}

function processCSV(type, text) {
    const lines = text.split('\n');
    const headers = lines[0].split(',');
    let successCount = 0;

    if(type === 'expenses') {
        const currentExps = DB.getExpenses();
        for(let i=1; i<lines.length; i++) {
            if(!lines[i].trim()) continue;
            // Simple CSV parse (fails on commas inside quotes without regex, but sufficient for basic backups)
            // Using a simple regex split for robustness
            const row = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(s => s.replace(/"/g, ''));
            
            if(row.length < 5) continue; 
            
            // Map row to object (Index based on Export order)
            // expenseId,date,category,description,amount,currency,appliedRate,twdEquivalent,payerUID,shares,paymentMethod,walletId,notes
            const newExp = {
                expenseId: row[0],
                dateTime: row[1] + " 12:00", // Approx
                category: row[2],
                description: row[3],
                amount: parseFloat(row[4]),
                currency: row[5],
                appliedRate: parseFloat(row[6]),
                twdEquivalent: parseFloat(row[7]),
                payerUID: row[8],
                shares: row[9].split('|'),
                paymentMethod: row[10],
                walletId: row[11] === 'null' ? null : row[11],
                notes: row[12] || ""
            };

            // Dedupe
            if(!currentExps.find(e => e.expenseId === newExp.expenseId)) {
                currentExps.push(newExp);
                successCount++;
            }
        }
        DB.setExpenses(currentExps);
    } else {
        const currentWallets = DB.getWallets();
        for(let i=1; i<lines.length; i++) {
            if(!lines[i].trim()) continue;
            const row = lines[i].split(',');
            // walletId,ownerUID,currency,originalAmount,balance,rate,createdAt
            const newW = {
                walletId: row[0],
                ownerUID: row[1],
                currency: row[2],
                originalAmount: parseFloat(row[3]),
                balance: parseFloat(row[4]),
                rate: parseFloat(row[5]),
                createdAt: row[6]
            };
             // Upsert
            const idx = currentWallets.findIndex(w => w.walletId === newW.walletId);
            if(idx >= 0) currentWallets[idx] = newW;
            else currentWallets.push(newW);
            successCount++;
        }
        DB.setWallets(currentWallets);
    }
    alert(`æˆåŠŸåŒ¯å…¥ ${successCount} ç­†è³‡æ–™ï¼`);
    renderApp();
}

// ==========================================
// INITIALIZATION
// ==========================================
window.onload = function() {
    renderApp();
};

</script>
</body>
</html>